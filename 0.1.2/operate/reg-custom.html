<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 from src/site/xdoc/operate/reg-custom.xml.vm at 2020-08-13
 | Rendered using Apache Maven Fluido Skin 1.8
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.1" />
    <title>Registry Application &#x2013; Registry Customization</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.8.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.8.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="https://pds.nasa.gov" id="bannerLeft"><img src="../images/pds_banner.png"  alt="" width="500"/></a></div>
          <div class="pull-right"><a href="https://github.com/NASA-PDS/pds-registry-app" id="bannerRight"><h2>PDS Registry</h2>
</a></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2020-08-13<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 0.1.2</li>
      <li class="pull-right"><a href="https://github.com/NASA-PDS/pds-registry-app" class="externalLink" title="Registry App Github Repo">Registry App Github Repo</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Software Documentation</li>
    <li><a href="../index.html" title="About PDS Registry Application"><span class="none"></span>About PDS Registry Application</a></li>
    <li><a href="../install/index.html" title="Installation"><span class="icon-chevron-down"></span>Installation</a>
     <ul class="nav nav-list">
      <li><a href="../install/java.html" title="Java"><span class="none"></span>Java</a></li>
      <li><a href="../install/solr.html" title="Solr - Quick Start"><span class="none"></span>Solr - Quick Start</a></li>
      <li><a href="../install/tools.html" title="Tools (Manager, Harvest)"><span class="none"></span>Tools (Manager, Harvest)</a></li>
      <li><a href="../install/initialize.html" title="Initialize the Registry"><span class="none"></span>Initialize the Registry</a></li>
      <li><a href="../install/test.html" title="Test your deployment"><span class="none"></span>Test your deployment</a></li>
     </ul></li>
    <li><a href="../operate/index.html" title="Operation"><span class="icon-chevron-down"></span>Operation</a>
     <ul class="nav nav-list">
      <li><a href="../operate/common-ops.html" title="Common Operations"><span class="none"></span>Common Operations</a></li>
      <li><a href="../operate/test-vs-prod.html" title="Test vs Prod"><span class="none"></span>Test vs Prod</a></li>
      <li><a href="../operate/harvest.html" title="Harvest"><span class="none"></span>Harvest</a></li>
      <li><a href="../operate/reg-manager.html" title="Registry Manager"><span class="none"></span>Registry Manager</a></li>
      <li class="active"><a href="#"><span class="none"></span>Registry Customization</a></li>
      <li><a href="../operate/solr-tools.html" title="Solr Tools"><span class="none"></span>Solr Tools</a></li>
     </ul></li>
    <li><a href="../prod/index.html" title="Production Deployment"><span class="icon-chevron-down"></span>Production Deployment</a>
     <ul class="nav nav-list">
      <li><a href="../prod/solrcloud.html" title="SolrCloud"><span class="none"></span>SolrCloud</a></li>
      <li><a href="../prod/zookeeper-vm.html" title="ZooKeeper Installation (VM)"><span class="none"></span>ZooKeeper Installation (VM)</a></li>
      <li><a href="../prod/solr-vm.html" title="Solr Installation (VM)"><span class="none"></span>Solr Installation (VM)</a></li>
     </ul></li>
    <li><a href="../security/index.html" title="Security"><span class="icon-chevron-down"></span>Security</a>
     <ul class="nav nav-list">
      <li><a href="../security/proxy.html" title="Load Balancer & Proxy"><span class="none"></span>Load Balancer & Proxy</a></li>
      <li><a href="../security/zk.html" title="ZooKeeper"><span class="none"></span>ZooKeeper</a></li>
      <li><a href="../security/solr.html" title="Solr"><span class="none"></span>Solr</a></li>
     </ul></li>
    <li><a href="../reporting/index.html" title="Reporting & Visualization"><span class="none"></span>Reporting & Visualization</a></li>
    <li><a href="../index.html#Support" title="Support"><span class="none"></span>Support</a></li>
   <li class="nav-header">Downloads</li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/releases/download/0.1.2/pds-registry-app-0.1.2-bin.tar.gz" class="externalLink" title="Current Release (tar.gz)"><span class="none"></span>Current Release (tar.gz)</a></li>
    <li><a href="https://github.com/NASA-PDS/pds-registry-app/releases/download/0.1.2/pds-registry-app-0.1.2-bin.zip" class="externalLink" title="Current Release (zip)"><span class="none"></span>Current Release (zip)</a></li>
    <li><a href="https://pds-engineering.jpl.nasa.gov/content/pds4-software" class="externalLink" title="Past Releases"><span class="none"></span>Past Releases</a></li>
   <li class="nav-header">Change Log</li>
    <li><a href="../" title="TBD"><span class="none"></span>TBD</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >



<section>
<h2><a name="Registry_Customization"></a>Registry Customization</h2>



<section>
<h3><a name="Default_Configuration_Overview"></a>Default Configuration Overview</h3>

<p>
By default, PDS Registry stores its data in Apache Solr collection called &quot;registry&quot;.
Registry Manager comes with default &quot;configset&quot;, consisting of two files, <i>managed-schema</i> 
and <i>solrconfig.xml</i>, located in <i>REGISTRY_HOME/solr/collections/registry</i> folder.
<i>REGISTRY_HOME</i> is a directory where you installed Registry Manager, for example
<i>/home/pds/registry</i>.
</p>


<p>
Default <i>managed-schema</i> file defines few common fields such as 
</p>
<ul>

<li>lid</li>

<li>vid</li>

<li>lidvid</li>

<li>title</li>

<li>product_class</li>

<li>internal refrences</li>
</ul> 



<p>
and basic file information, such as 
</p>
<ul>

<li>file name</li>

<li>file type</li>

<li>file size</li>

<li>MD5 hash</li>
</ul>



<p>
Also, there is a binary field to store the whole label as a BLOB.
</p>
<div class="source"><pre class="prettyprint">
&lt;field name=&quot;_file_blob&quot; type=&quot;binary&quot; indexed=&quot;false&quot; stored=&quot;true&quot; required=&quot;false&quot; multiValued=&quot;false&quot; /&gt;
</pre></div>



<p>
Lidvid is a primary key. If you load the same Harvest-generated &quot;intermediate&quot; data file multiple times,
existing Solr documents will be replaced with new documents with the same lidvid. 
</p>
<div class="source"><pre class="prettyprint">
&lt;field name=&quot;lidvid&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; required=&quot;true&quot; multiValued=&quot;false&quot; /&gt;
&lt;uniqueKey&gt;lidvid&lt;/uniqueKey&gt;
</pre></div>



<p>
When you load data, unknown (undefined) fields are ignored.
</p>
<div class="source"><pre class="prettyprint">
&lt;dynamicField name=&quot;*&quot; type=&quot;ignored&quot; /&gt;
&lt;fieldType name=&quot;ignored&quot; stored=&quot;false&quot; indexed=&quot;false&quot; multiValued=&quot;true&quot; class=&quot;solr.StrField&quot; /&gt;
</pre></div>

</section>



<section>
<h3><a name="Customization_Overview"></a>Customization Overview</h3>
<section>
<h4><a name="Adding_More_Fields"></a>Adding More Fields</h4>

<p>
Default configuration defines just a few common fields. To add more fields, you have to change Solr schema. 
Solr supports both static (changing configuration files) and dynamic (calling API) schema configuration.
</p>

</section><section>
<h4><a name="Using_Multiple_Collections"></a>Using Multiple Collections</h4>

<p>
You could store original PDS labels (in a BLOB field) and some basic metadata in the &quot;registry&quot; collection.
In addition to that you could have &quot;search&quot; collection with more fields and only the latest version of the labels.
</p>

</section><section>
<h4><a name="Full_Text_Search_Customization"></a>Full Text Search Customization</h4>

<p>
To optimize full text search, you may want to customize Solr index and query-time analyzers (filters, tokenizers),
define Solr copy fields or configure Harvest to merge multiple fields.
</p>
</section></section>
 	


<section>
<h3><a name="Adding_More_Fields"></a>Adding More Fields</h3>


<p>
Detailed information about Solr fields and schema design is available at 
<a class="externalLink" href="https://lucene.apache.org/solr/guide/8_4/documents-fields-and-schema-design.html" target="_blank">Solr website</a>.
</p>



<section>
<h4><a name="Manually_editing_managed-schema_file"></a>Manually editing managed-schema file</h4>


<p>
Either edit <i>managed-schema</i> file in <i>REGISTRY_HOME/solr/collections/registry</i> folder or copy
all files from <i>REGISTRY_HOME/solr/collections/registry</i> to another folder and edit <i>managed-schema</i> file there.
</p>


<p>
For example, copy the following XML to <i>managed-schema</i> file to add 
<i>start_date_time</i> and <i>stop_date_time</i> fields to the registry collection.
</p>
<div class="source"><pre class="prettyprint">
&lt;field name=&quot;start_date_time&quot; type=&quot;pdate&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot;/&gt;
&lt;field name=&quot;stop_date_time&quot; type=&quot;pdate&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot;/&gt;
</pre></div>



<p>
To apply the changes you have to delete the registry collection and all its data! 
</p>
<div class="source"><pre class="prettyprint">
registry-manager delete-registry
</pre></div>



<p>
and then recreate the collection.
</p>
<div class="source"><pre class="prettyprint">
registry-manager create-registry
</pre></div>



<p>
If you copied default configset from <i>REGISTRY_MANAGER_HOME/solr/collections/registry</i> to some other
directory, for example <i>/tmp/reg</i>, pass <i>-configDir</i> flag to Registry Manager.
</p>

<div class="source"><pre class="prettyprint">
registry-manager create-registry -configDir /tmp/reg
</pre></div>


<p>
You can also customize collection name and Solr / Zookeeper URL.
</p>

<div class="source"><pre class="prettyprint">
registry-manager create-registry -configDir /tmp/reg -collection test1 -solrUrl http://myhost:8983/solr
</pre></div>



</section><section>
<h4><a name="Adding_fields_dynamically"></a>Adding fields dynamically</h4>

<p>
You can add and delete fields dynamically by calling Solr Schema API. 
For example, to add <i>start_date_time</i> field call this API:
</p>
<div class="source"><pre class="prettyprint">
curl http://localhost:8983/solr/registry/schema -X POST -H 'content-type:application/json' --data-binary '{
  &quot;add-field&quot;: {
     &quot;name&quot;:&quot;start_date_time&quot;,
     &quot;type&quot;:&quot;pdate&quot;,
     &quot;indexed&quot;:true,
     &quot;stored&quot;:true,
     &quot;multiValued&quot;:true
  }
}'
</pre></div>




</section><section>
<h4><a name="Generating_Solr_fields_from_PDS4_data_dictionaries"></a>Generating Solr fields from PDS4 data dictionaries</h4>

<p>
Registry manager can generate Solr field definitions from one or more PDS4 data dictionaries.
Only data dictionaries in JSON format are supported.
Latest versions of PDS4 data dictionaries in different formates are available at 
<a class="externalLink" href="https://pds.nasa.gov/datastandards/dictionaries/" target="_blank">PDS website</a>.
Generated Solr field definitions are stored in an XML file and have to be manually copied to
<i>managed-schema</i> file.
</p>

<section>
<h5><a name="Getting_Started"></a>Getting Started</h5>


<p>
Let's extract autoexposure fields from imaging data dictionary, <i>PDS4_IMG_1D00_1700.JSON</i>.
</p>


<p>
First, create a configuration file and save it as <i>/tmp/example.xml</i>.
</p>
<div class="source"><pre class="prettyprint">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;schemaGen&gt;

  &lt;dataDictionary baseDir=&quot;/tmp/schema&quot;&gt;
    &lt;file&gt;PDS4_IMG_1D00_1700.JSON&lt;/file&gt;
  &lt;/dataDictionary&gt;

  &lt;classFilters&gt;
    &lt;include&gt;img.Autoexposure&lt;/include&gt;
  &lt;/classFilters&gt;

&lt;/schemaGen&gt;
</pre></div>



<p>
The file has several sections. Data dictionary sections lists all dictionary files to be processed.
This section is required and should contain one or more data dictionary files.
In this example, imaging data dictionary <i>PDS4_IMG_1D00_1700.JSON</i> is located in <i>/tmp/schema</i> folder.
If you want to use different folder or file, adjust your configuration file accordingly.
</p>


<p>
Class filter section is optional. Without this section, all classes and its attributes from data dictionary will be
processed. You can limit number of classes by providing either include or exclude filters, but not both.
In this example only <i>img.Autoexposure</i> class and its attributes will be processed.
Note that class name includes <i>img</i> namespace.
</p>


<p>
Run <i>generate-solr-schema</i> registry manager command to generate Solr field definitions.
</p>

<div class="source"><pre class="prettyprint">
registry-manager generate-solr-schema -config /tmp/example.xml
</pre></div>


<p>
By default, generated field definitions are saved in <i>/tmp/registry/solr-fields.xml</i> file. 
You can change default output directory by providing <i>-outDir</i> parameter. For example,
</p>

<div class="source"><pre class="prettyprint">
registry-manager generate-solr-schema -config /tmp/example.xml -outDir /home/pds4/schema
</pre></div>


<p>
Example <i>solr-fields.xml</i> file is shown below.
</p>
<div class="source"><pre class="prettyprint">
&lt;fields&gt;
&lt;field name=&quot;img.Autoexposure.img.auto_exposure_data_cut&quot; type=&quot;pint&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.active_flag&quot; type=&quot;boolean&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.auto_exposure_percent&quot; type=&quot;pdouble&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.processing_venue&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.auto_exposure_pixel_fraction&quot; type=&quot;pdouble&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.processing_algorithm&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.max_auto_exposure_iteration_count&quot; type=&quot;pint&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;img.Autoexposure.img.sequence_number&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;/fields&gt;
</pre></div>



<p>
The following naming convention is used for generated Solr fields:
</p>
<div class="source"><pre class="prettyprint">
&lt;namespace&gt;.&lt;class name&gt;.&lt;namespace&gt;.&lt;attribute name&gt;
</pre></div>


</section><section>
<h5><a name="Data_Type_Map"></a>Data Type Map</h5>


<p>
You might have noticed few warnings when running registry manager.
</p>
<div class="source"><pre class="prettyprint">
[WARN] No PDS to Solr data type mapping for 'pds.ASCII_Integer'. Will use 'pint'
[WARN] No PDS to Solr data type mapping for 'pds.ASCII_Boolean'. Will use 'boolean'
[WARN] No PDS to Solr data type mapping for 'pds.ASCII_Real'. Will use 'pdouble'
[WARN] No PDS to Solr data type mapping for 'pds.ASCII_Short_String_Collapsed'. Will use 'string'
</pre></div>



<p>
Attributes in data dictionary files have PDS data types, such as <i>pds.ASCII_Integer</i>.
Registry manager will try to convert PDS data types to Solr data types automatically.
You can also provide your own mappings.
</p>


<p>
Add the following section in the configuration file (<i>/tmp/example.xml</i>):
</p>
<div class="source"><pre class="prettyprint">
  &lt;dataTypes baseDir=&quot;/tmp/schema&quot;&gt;
    &lt;file&gt;data-types.cfg&lt;/file&gt;
  &lt;/dataTypes&gt;
</pre></div>



<p>
And another file, <i>/tmp/schema/data-types.cfg</i> with mappings.
</p>
<div class="source"><pre class="prettyprint">
pds.ASCII_Integer = pint
pds.ASCII_Boolean = boolean
pds.ASCII_Real = pdouble
pds.ASCII_Short_String_Collapsed = string
</pre></div>



<p>
The format of this file is very simle:
</p>

<div class="source"><pre class="prettyprint">
&lt;PDS data type with namespace&gt; = &lt;Solr data type&gt;
</pre></div>

</section><section>
<h5><a name="Custom_Generators"></a>Custom Generators</h5>

<p>
Instead of automatically generating Solr fields from data dictionary class attributes, you can define
custom generators per data dictionary class.
</p>

<p>
First, let's use a configuration file without custom generators (/tmp/example.xml):
</p>

<div class="source"><pre class="prettyprint">
&lt;schemaGen&gt;
  &lt;dataDictionary baseDir=&quot;/tmp/schema&quot;&gt;
    &lt;file&gt;PDS4_PDS_JSON_1D00.JSON&lt;/file&gt;
  &lt;/dataDictionary&gt;
  &lt;classFilters&gt;
    &lt;include&gt;pds.Observing_System_Component&lt;/include&gt;
  &lt;/classFilters&gt;
&lt;/schemaGen&gt;
</pre></div>


<p>
If you run Solr schema generator
</p>

<div class="source"><pre class="prettyprint">
registry-manager generate-solr-schema -config /tmp/example.xml
</pre></div>


<p>
The following fields will be generated:
</p>
<div class="source"><pre class="prettyprint">
&lt;field name=&quot;pds.Observing_System_Component.pds.name&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;pds.Observing_System_Component.pds.type&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;pds.Observing_System_Component.pds.description&quot; type=&quot;text_general&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
</pre></div>



<p>
Now, let's add the following section to the main configuration file (<i>/tmp/example.xml</i>)
</p>
<div class="source"><pre class="prettyprint">
&lt;customGenerators baseDir=&quot;/tmp/schema&quot;&gt;
  &lt;class name=&quot;pds.Observing_System_Component&quot; file=&quot;Observing_System_Component.cfg&quot; /&gt;
&lt;/customGenerators&gt;
</pre></div>



<p>
and another custom generator file, <i>/tmp/schema/Observing_System_Component.cfg</i>
</p>
<div class="source"><pre class="prettyprint">
instrument_name = string
spacecraft_name = string
</pre></div>



<p>
The format of this file is very simle:
</p>

<div class="source"><pre class="prettyprint">
&lt;Solr field name&gt; = &lt;Solr data type&gt;
</pre></div>


<p>
If you run Solr schema generator
</p>

<div class="source"><pre class="prettyprint">
registry-manager generate-solr-schema -config /tmp/example.xml
</pre></div>


<p>
The following custom fields will be generated:
</p>
<div class="source"><pre class="prettyprint">
&lt;field name=&quot;instrument_name&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
&lt;field name=&quot;spacecraft_name&quot; type=&quot;string&quot; indexed=&quot;true&quot; stored=&quot;true&quot; multiValued=&quot;true&quot; required=&quot;false&quot; /&gt;
</pre></div>




</section></section><section>
<h4><a name="Updating_Solr_schema_from_PDS4_data_dictionaries"></a>Updating Solr schema from PDS4 data dictionaries</h4>


<p>
To updates Solr schema dynamically, by calling Solr schema API, run the following Registry Manager command:
</p>

<div class="source"><pre class="prettyprint">
registry-manager update-solr-schema -config /tmp/example.xml
</pre></div>


<p>
This command uses the same configuration file as <i>generate-solr-schema</i> command described in previous section.
</p>


<p>
By default, <i>&quot;registry&quot;</i> collection of local Solr instance <i>http://localhost:8983/solr</i> is updated.
Both collection name and Solr / ZooKeeper URL are configurable as shown below:
</p>


<div class="source"><pre class="prettyprint">
registry-manager update-solr-schema -config /tmp/example.xml -collection test1 -solrUrl http://myhost:8983/solr
</pre></div>


<p>
Solr collection must exist, before calling <i>update-solr-schema</i> command.
</p>
</section></section>
</section>



        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &#169;      2020..</p>
        </div>
      </div>
    </footer>
  </body>
</html>
