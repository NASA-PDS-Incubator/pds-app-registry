<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.9.1 from src/site/xdoc/operate/harvest.xml.vm at 2020-03-30
 | Rendered using Apache Maven Fluido Skin 1.8
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.9.1" />
    <title>Registry Application &#x2013; Harvest Operation</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.8.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.8.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="https://github.com/NASA-PDS-Incubator/pds-app-registry" id="bannerLeft"><img src="../images/pds4_logo.png"  alt=""/></a></div>
          <div class="pull-right"><div id="bannerRight"><h2>PDS Registry</h2>
</div>
</div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 2020-03-30<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 0.1.0-SNAPSHOT</li>
      <li class="pull-right"><a href="https://github.com/NASA-PDS-Incubator/pds-app-registry" class="externalLink" title="Registry App Github Repo">Registry App Github Repo</a></li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Software Documentation</li>
    <li><a href="../index.html" title="About PDS Registry Application"><span class="none"></span>About PDS Registry Application</a></li>
    <li><a href="../install/index.html" title="Installation"><span class="icon-chevron-down"></span>Installation</a>
     <ul class="nav nav-list">
      <li><a href="../install/java.html" title="Java"><span class="none"></span>Java</a></li>
      <li><a href="../install/solr.html" title="Solr"><span class="none"></span>Solr</a></li>
      <li><a href="../install/tools.html" title="Tools (manager, harvest)"><span class="none"></span>Tools (manager, harvest)</a></li>
      <li><a href="../install/initialize.html" title="Initialize the registry"><span class="none"></span>Initialize the registry</a></li>
      <li><a href="../install/test.html" title="Test your deployment"><span class="none"></span>Test your deployment</a></li>
     </ul></li>
    <li><a href="../operate/index.html" title="Operation"><span class="icon-chevron-down"></span>Operation</a>
     <ul class="nav nav-list">
      <li class="active"><a href="#"><span class="none"></span>Harvest</a></li>
      <li><a href="../operate/reg-manager.html" title="Registry Manager"><span class="none"></span>Registry Manager</a></li>
      <li><a href="../operate/reg-collection.html" title="Registry Collection"><span class="none"></span>Registry Collection</a></li>
      <li><a href="../operate/solr-tools.html" title="Solr Tools"><span class="none"></span>Solr Tools</a></li>
     </ul></li>
   <li class="nav-header">Downloads</li>
    <li><a href="https://github.com/NASA-PDS-Incubator/pds-app-registry/releases/download/0.1.0-SNAPSHOT/pds-app-registry-0.1.0-SNAPSHOT-bin.tar.gz" class="externalLink" title="Current Release (tar.gz)"><span class="none"></span>Current Release (tar.gz)</a></li>
    <li><a href="https://github.com/NASA-PDS-Incubator/pds-app-registry/releases/download/0.1.0-SNAPSHOT/pds-app-registry-0.1.0-SNAPSHOT-bin.zip" class="externalLink" title="Current Release (zip)"><span class="none"></span>Current Release (zip)</a></li>
    <li><a href="https://pds-engineering.jpl.nasa.gov/content/pds4-software" class="externalLink" title="Past Releases"><span class="none"></span>Past Releases</a></li>
   <li class="nav-header">Change Log</li>
    <li><a href="../" title="TBD"><span class="none"></span>TBD</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <hr />
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >



<section>
<h2><a name="Harvest_Overview"></a>Harvest Overview</h2>

<p>
Harvest is a command-line tool for extracting metadata from PDS4 products (labels).
It parses PDS4 files and stores extracted metadata in an intermediate XML file.
This intermediate file can be loaded into Solr by Registry Manager or standard Solr tools, 
such as Solr post tool.
</p>

<p>
Harvest executable scripts for Windows (<i>harvest.bat</i>) and Linux / Mac (<i>harvest</i>) 
are located in <i>bin</i> sub-folder of the installation directory (e.g., <i>/home/pds/harvest/</i>).
</p>

<p>
To see the basic usage information (shown below) run Harvest without any parameters.
</p>

<div class="source"><pre class="prettyprint">
usage: harvest &lt;options&gt;
 -c  &lt;file&gt;    Harvest configuration file.
 -l  &lt;file&gt;    Log file. Default is /tmp/harvest/harvest.log.
 -o  &lt;dir&gt;     Output directory for Solr documents. Default is /tmp/harvest/solr
 -v  &lt;level&gt;   Logger verbosity: 0=Debug, 1=Info (default), 2=Warning, 3=Error.
</pre></div>
</section>

<section>
<h2><a name="Quick_Start"></a>Quick Start</h2>

<p>
To run Harvest you need an XML configuration file. 
For example, to process all XML files in <i>/data/LADEE/ldex_20161118</i> folder and 
all subfolders, create the following configuration file and save it as <i>/tmp/ladee.cfg</i>.
</p>


<div class="source"><pre class="prettyprint">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;harvest&gt;
  &lt;directories&gt;
    &lt;path&gt;/data/LADEE/ldex_20161118&lt;/path&gt;
    &lt;fileFilter&gt;
      &lt;include&gt;*.xml&lt;/include&gt;
    &lt;/fileFilter&gt;
  &lt;/directories&gt;
&lt;/harvest&gt;
</pre></div>


<p>
Then run Harvest
</p>
<div class="source"><pre class="prettyprint">
harvest -c /tmp/ladee.cfg
</pre></div>



<p>
The tool will print some log messages and create an intermediate file, <i>solr-docs.xml</i> 
in default output directory <i>/tmp/harvest/solr/</i>. The file contains a list of Solr documents
in XML format whch can be loaded into Solr by Registry Manager or standard Solr tools.
An example Solr document is shown below.

</p>
<div class="source"><pre class="prettyprint">
&lt;doc&gt;
  &lt;field name=&quot;lid&quot;&gt;urn:nasa:pds:ladee_ldex&lt;/field&gt;
  &lt;field name=&quot;vid&quot;&gt;1.2&lt;/field&gt;
  &lt;field name=&quot;lidvid&quot;&gt;urn:nasa:pds:ladee_ldex::1.2&lt;/field&gt;
  &lt;field name=&quot;title&quot;&gt;LADEE LUNAR DUST EXPERIMENT&lt;/field&gt;
  &lt;field name=&quot;product_class&quot;&gt;Product_Bundle&lt;/field&gt;
  &lt;field name=&quot;_file_name&quot;&gt;bundle_ladee_ldex.xml&lt;/field&gt;
  &lt;field name=&quot;_file_type&quot;&gt;application/xml&lt;/field&gt;
  &lt;field name=&quot;_file_size&quot;&gt;5735&lt;/field&gt;
  &lt;field name=&quot;_file_md5&quot;&gt;zlYAt05W/Ag6Qy4HlNYy+g==&lt;/field&gt;
  &lt;field name=&quot;_xml_root_element&quot;&gt;Product_Bundle&lt;/field&gt;
  &lt;field name=&quot;_package_id&quot;&gt;8627271a-01f5-49ad-8ce5-69f78fd6b5f4&lt;/field&gt;
  &lt;field name=&quot;instrument_host_ref&quot;&gt;urn:nasa:pds:context:instrument_host:spacecraft.ladee&lt;/field&gt;
  &lt;field name=&quot;instrument_ref&quot;&gt;urn:nasa:pds:context:instrument:instrument.ldex__ladee&lt;/field&gt;
  &lt;field name=&quot;investigation_ref&quot;&gt;urn:nasa:pds:context:investigation:mission.ladee&lt;/field&gt;
  &lt;field name=&quot;target_ref&quot;&gt;urn:nasa:pds:context:target:dust.dust&lt;/field&gt;
  &lt;field name=&quot;target_ref&quot;&gt;urn:nasa:pds:context:target:satellite.moon&lt;/field&gt;
&lt;/doc&gt;
</pre></div>



<p>
By default Harvest extracts lid, vid, title, product_class, all internal refrences and basic
file information, such as file name, type, size, and MD5 hash.
</p>

<section><section>
<h4><a name="Package_ID"></a>Package ID</h4>

<p>
Each Harvest run generates unique package ID, stored in <i>_package_id</i> field.
After loading extracted metadata into Solr, all documents from a particular Harvest run can be 
deleted by this package id.
</p>

</section></section></section>



<section>
<h2><a name="Extracting_More_Metadata"></a>Extracting More Metadata</h2>

<p>
For example, to extract <i>start_date_time</i> and <i>stop_date_time</i> from observational products,
you have to define an XPath to field name map. First, create an XML file shown below and save it as
<i>/home/pds/harvest/conf/observational.xml</i>. You can use another file name or directory if you want.

</p>
<div class="source"><pre class="prettyprint">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;

&lt;xpaths&gt;
  &lt;xpath fieldName=&quot;start_date_time&quot;&gt;/Product_Observational/Observation_Area/Time_Coordinates/start_date_time&lt;/xpath&gt;
  &lt;xpath fieldName=&quot;stop_date_time&quot;&gt;/Product_Observational/Observation_Area/Time_Coordinates/stop_date_time&lt;/xpath&gt;
&lt;/xpaths&gt;
</pre></div>



<p>
These XPaths will be used to extract start and stop date values which will be saved in the intermediate XML file as
<i>start_date_time</i> and <i>stop_date_time</i> fields.
</p>


<p>
Next, add the following section to the Harvest configuration file.

</p>
<div class="source"><pre class="prettyprint">
&lt;harvest&gt;
...
  &lt;xpathMaps baseDir=&quot;/home/pds/harvest/conf&quot;&gt;
    &lt;xpathMap rootElement=&quot;Product_Observational&quot; filePath=&quot;observational.xml&quot; /&gt;
  &lt;/xpathMaps&gt;
&lt;/harvest&gt;
</pre></div>



<p>
Now, if you run Harvest, Solr documents for observational products will contain start and stop dates.
</p>
<div class="source"><pre class="prettyprint">
&lt;doc&gt;
  &lt;field name=&quot;lid&quot;&gt;urn:nasa:pds:ladee_ldex:data_derived:derived_ldex_ltden_pds_derived_tab&lt;/field&gt;
  &lt;field name=&quot;vid&quot;&gt;1.2&lt;/field&gt;
...
  &lt;field name=&quot;start_date_time&quot;&gt;2013-10-25T00:00:00Z&lt;/field&gt;
  &lt;field name=&quot;stop_date_time&quot;&gt;2014-04-18T04:30:00Z&lt;/field&gt;
&lt;/doc&gt;
</pre></div>



<p>
Note that baseDir attribute is optional. You can also provide full path in filePath attribute
as shown below

</p>
<div class="source"><pre class="prettyprint">
  &lt;xpathMaps&gt;
    &lt;xpathMap rootElement=&quot;Product_Observational&quot; filePath=&quot;/home/pds/harvest/conf/observational.xml&quot; /&gt;
  &lt;/xpathMaps&gt;
</pre></div>



<p>
The rootElement attribute is also optional. In the above example, the XPath queries will run 
against observational products only. If you remove rootElement attribute, then the same XPath queries 
will run against all products, such as Product_Collection, Product_Document, etc.
</p>


<p>
Finally, you can have multiple &lt;xpathMap&gt; entries, even for the same rootElement.
</p>

</section>



<section>
<h2><a name="BLOB_Storage"></a>BLOB Storage</h2>

<p>
You can store whole PDS product labels as BLOBs (Binary Large OBjects). 
To enable this feature add the following section in Harvest configuration file.
</p>
<div class="source"><pre class="prettyprint">
&lt;blobStorage type=&quot;embedded&quot; /&gt;
</pre></div>


<p>
After running Harvest, <i>solr-docs.xml</i> &quot;intermediate&quot; file will have <i>_file_blob</i> field with zipped product label. 
You can expect up to 900% compression rate for some files. 
For example, many LADEE housekeeping labels are about 45KB. BLOB size is about 5KB.
For smaller files, such as collection labels, compression rate is about 350% (5.5KB file is compressed to 1.6KB).
</p>

<p>
After loading data into Solr, you can extract BLOBs by running Registry Manager tool:
</p>
<div class="source"><pre class="prettyprint">
registry-manager export-file -lidvid urn:nasa:pds:ladee_ldex:data_calibrated::1.2 -filePath /tmp/data_calibrated.xml
</pre></div>


</section>



<section>
<h2><a name="File_Reference_.2F_Access_URL"></a>File Reference / Access URL</h2>

<p>
To store full path of a product label file, add the following section in Harvest configuration file.
</p>
<div class="source"><pre class="prettyprint">
&lt;fileRef/&gt;
</pre></div>


<p>
After running Harvest, you should see <i>_file_ref</i> field added to each Solr document:
</p>
<div class="source"><pre class="prettyprint">
&lt;doc&gt;
...
  &lt;field name=&quot;_file_ref&quot;&gt;/C:/data/LADEE/ldex_20161118/bundle_ladee_ldex.xml&lt;/field&gt;
...
&lt;/doc&gt;
</pre></div>
Note that on Windows, backslashes are replaced with forward slashes and disk letter is included.



<p>
To replace file path prefix with another value, let's change &lt;fileRef/&gt; tag in Harvest configuration file:
</p>
<div class="source"><pre class="prettyprint">
&lt;fileRef&gt;
  &lt;replace prefix=&quot;/C:/data/LADEE/&quot; replacement=&quot;https://pds.nasa.gov/data/pds4/&quot; /&gt;
&lt;/fileRef&gt;
</pre></div>



<p>
Now, after running Harvest, you shoul see different <i>_file_ref</i> value:
</p>
<div class="source"><pre class="prettyprint">
&lt;doc&gt;
...
  &lt;field name=&quot;_file_ref&quot;&gt;https://pds.nasa.gov/data/pds4/ldex_20161118/bundle_ladee_ldex.xml&lt;/field&gt;
...
&lt;/doc&gt;
</pre></div>


</section>



<section>
<h2><a name="Directories_and_Filters"></a>Directories and Filters</h2>

<section><section>
<h4><a name="Crawl_Products_from_Multiple_Directories"></a>Crawl Products from Multiple Directories</h4>

<p>
To process products from multiple directories, specify multiple &lt;path&gt; entries in Harvest configuration file:
</p>
<div class="source"><pre class="prettyprint">
&lt;harvest&gt;
  &lt;directories&gt;
    &lt;path&gt;/data/LADEE/ldex_20161118/data_calibrated&lt;/path&gt;
    &lt;path&gt;/data/LADEE/ldex_20161118/data_derived&lt;/path&gt;
...
&lt;/harvest&gt;
</pre></div>


</section><section>
<h4><a name="Filtering_Files"></a>Filtering Files</h4>

<p>
This feature has limited functionality since all PDS4 product labels are XML files and
Harvest could not process other files. Usually you would include the following file filter in most 
Harvest configuration files:
</p>
<div class="source"><pre class="prettyprint">
&lt;harvest&gt;
  &lt;directories&gt;
...
    &lt;fileFilter&gt;
      &lt;include&gt;*.xml&lt;/include&gt;
    &lt;/fileFilter&gt;
  &lt;/directories&gt;
&lt;/harvest&gt;
</pre></div>
If you don't provide any filters, Harvest will try to pocess every file and for non-XML files you will see
&quot;Unsupported MIME type&quot; log messages.


<p>
You can use one or more &lt;include&gt; filters or one or more &lt;exclude&gt; filters, but not 
both &lt;include&gt; and &lt;exclude&gt; at the same time.
</p>

</section><section>
<h4><a name="Excluding_Sub-Directories"></a>Excluding Sub-Directories</h4>

<p>
For example, to exclude <i>xml_schema</i> sub-folder, add a directory filter in Harvest configuration file:
</p>
<div class="source"><pre class="prettyprint">
&lt;harvest&gt;
  &lt;directories&gt;
...
    &lt;directoryFilter&gt;
      &lt;exclude&gt;xml_schema&lt;/exclude&gt;
    &lt;/directoryFilter&gt;
  &lt;/directories&gt;
&lt;/harvest&gt;
</pre></div>
There is no include option for sub-directories.


</section><section>
<h4><a name="Filtering_Products"></a>Filtering Products</h4>

<p>
You can include or exclude products. For example, to only process documents, add following 
product filter in Harvest configuration file:
</p>

<div class="source"><pre class="prettyprint">
&lt;harvest&gt;
  &lt;directories&gt;
...
    &lt;productFilter&gt;
      &lt;include&gt;Product_Document&lt;/include&gt;
    &lt;/productFilter&gt;
  &lt;/directories&gt;
&lt;/harvest&gt;
</pre></div>

</section></section></section>





        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &#169;      2020..</p>
        </div>
      </div>
    </footer>
  </body>
</html>
